# Base image
FROM php:8.2-fpm

# Arguments creating a user in our docker not the root
ARG user
ARG uid

# dependencies
RUN apt-get update && apt-get install -y \
    git \
    curl \
    libpng-dev \
    libonig-dev \
    libxml2-dev \
    zip \
    unzip

#clean up the package manager
RUN apt-get clean && rm -rf /var/lib/apt/lists/*

# install php extensions --pdo mysql extensions for connecting to db
RUN docker-php-ext-install pdo_mysql mbstring exif pcntl bcmath gd

# install composer
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# add the user created you passed to ww data group
RUN useradd -u $uid -ms /bin/bash -g www-data $user

# copying the files to www
COPY --chown=$user:www-data . /var/www

# Set working directory
WORKDIR /var/www

# Change ownership of /var/www to the user
RUN chown -R $user:www-data /var/www

EXPOSE 9000

# Configure PHP-FPM to listen on all interfaces (0.0.0.0:9000) instead of just localhost
# This allows nginx in another container to connect to it
RUN sed -i 's/listen = 127.0.0.1:9000/listen = 0.0.0.0:9000/' /usr/local/etc/php-fpm.d/www.conf || \
    sed -i 's/listen = .*/listen = 0.0.0.0:9000/' /usr/local/etc/php-fpm.d/www.conf || \
    echo "listen = 0.0.0.0:9000" >> /usr/local/etc/php-fpm.d/www.conf

# Ensure PHP-FPM runs as www-data (default, but making it explicit)
RUN sed -i 's/;listen.owner = www-data/listen.owner = www-data/' /usr/local/etc/php-fpm.d/www.conf && \
    sed -i 's/;listen.group = www-data/listen.group = www-data/' /usr/local/etc/php-fpm.d/www.conf

# PHP-FPM needs to run as root initially to bind to port 9000, then it will drop privileges
# The php-fpm image already handles this correctly, so we just need to ensure it listens on 0.0.0.0

CMD ["php-fpm", "-F"]